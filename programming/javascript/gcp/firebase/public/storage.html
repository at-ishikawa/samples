<html>
  <head>
    <title>Firebase sample</title>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-storage.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-analytics.js"></script>
  </head>
  <body>
    Firebase sample

    <form>
      Upload: <input id="file" type="file" />
    </form>

    <div id="progress"></div>

    <script src="./firebase-init.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var storage = firebase.app().storage().ref();

        var fileDOM = document.querySelector('#file');
        fileDOM.addEventListener('change', function () {
          if (!this.files.length) {
            return;
          }

          var file = this.files[0];
          var reader = new FileReader();
          reader.onload = function(event) {
            var binary = event.target.result;
            var pathName = file.name;
            var image = storage.child(pathName);
            var metadata = {
              contentType: file.type,
            };
            var uploadTask = image.put(new Blob([binary]), metadata);
            uploadTask.on('state_changed', function (snapshot) {
              var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              console.log('Upload is ' + progress + '% done');
              switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED: // or 'paused'
                  console.log('Upload is paused');
                  break;
                case firebase.storage.TaskState.RUNNING: // or 'running'
                  console.log('Upload is running');
                  break;
              }
              document.querySelector('#progress').innerHTML = 'Upload is ' + snapshot.state + '... ' + progress + '% done';
            });
            uploadTask.then(function(snapshot) {
              // Handle successful uploads on complete
              // For instance, get the download URL: https://firebasestorage.googleapis.com/...
              console.log(snapshot);
              snapshot.ref.getDownloadURL().then(function(downloadURL) {
                console.log('File available at', downloadURL);
                document.querySelector('#progress').innerHTML = 'File available at ' + downloadURL;
              });
            })
                      .catch(function(error) {
                        console.error(error);
                      });
          }
          reader.readAsArrayBuffer(file);
        });
      });
    </script>
  </body>
</html>
